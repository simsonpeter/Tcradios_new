<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TC RADIOS</title>
<link rel="shortcut icon" href="https://raw.githubusercontent.com/simsonpeter/Tcradios/main/icons/favicon.ico"/>
<meta name="theme-color" content="#f97316"/>
<style>
:root{
  --accent:#f97316;--bg:#111827;--card:#1f2937;--text:#f3f4f6;
  --border:#374151;--header:#000000;--heart:#f3f4f6;
}
[data-theme="light"]{
  --bg:#f5f7fa;--card:#ffffff;--text:#1e293b;
  --border:#d1d5db;--header:#ffffff;--heart:#1e293b;
}
*{box-sizing:border-box;margin:0;padding:0}
body{height:100vh;display:flex;flex-direction:column;font-family:system-ui;
     background:var(--bg);color:var(--text);overflow:hidden}
header{background:var(--header);border-bottom:1px solid var(--border);
       display:flex;justify-content:space-between;align-items:center;
       padding:.5rem .8rem;font-size:1.25rem;font-weight:700;flex-shrink:0}
header button{background:none;border:none;font-size:1.4rem;cursor:pointer}
#langBox{position:relative;margin-left:auto;margin-right:1rem}
#langSelect{appearance:none;background:var(--card);color:var(--text);
            border:1px solid var(--border);border-radius:.4rem;
            padding:.35rem .6rem;font-size:1rem;cursor:pointer}
#tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;
      background:var(--header)}
#tabs span{flex:1;text-align:center;padding:.55rem 0;cursor:pointer;
           font-weight:600;color:var(--text);border-radius:0 .5rem .5rem 0}
#tabs span:first-child{border-radius:.5rem 0 0 .5rem}
#tabs span.active{background:var(--accent);color:#fff}
#content,#about-panel{flex:1;overflow-y:auto;padding:.75rem 1rem 4.5rem; /* ‚Üê FIX */
                      display:flex;flex-direction:column;justify-content:flex-start}
#about-panel{display:none;align-items:center;justify-content:center}
.about-card{background:var(--card);border-radius:.5rem;padding:1rem;
            text-align:center;box-shadow:0 1px 3px rgba(0,0,0,.08);
            width:90%;max-width:400px;margin-bottom:1rem}
.about-card img{width:90px;height:90px;border-radius:50%;object-fit:cover;margin-bottom:.5rem}
.about-card h2{margin:.3rem 0;font-size:1.2rem;color:var(--accent)}
.about-card p{font-size:.9rem;line-height:1.4}

/* STATION LIST */
.station-list{width:100%;display:flex;flex-direction:column;gap:.4rem}
.item{display:flex;align-items:center;gap:12px;padding:.5rem;border-radius:.5rem;
      background:var(--card);box-shadow:0 1px 3px rgba(0,0,0,.08)}
.station-icon{width:48px;height:48px;border-radius:50%;object-fit:cover}
.station-info{flex:1;display:flex;flex-direction:column;text-align:left}
.station-name{font-weight:600}
.station-genre{font-size:.8rem;color:var(--accent)}
.favorite-button{font-size:1.3rem;color:var(--heart);cursor:pointer}
.favorite-button.on{color:var(--accent)}

/* PLAYER */
#player{background:var(--header);border-top:1px solid var(--border);
        display:flex;align-items:center;gap:.5rem;padding:.4rem .6rem;
        position: fixed; bottom: 0; width: 100%; flex-shrink:0; z-index: 100;}
#player img{width:44px;height:44px;border-radius:50%;
           animation:spin 3s linear infinite paused}
#player.playing img{animation-play-state:running}
@keyframes spin{to{transform:rotate(360deg)}}
#player .info{flex:1;display:flex;flex-direction:column;justify-content:center;min-width:0}
#player .name{white-space:nowrap;overflow:hidden;font-weight:700;font-size:.95rem}
#player .name span{display:inline-block;padding-right:1rem;
                   animation:marquee 8s linear infinite}
@keyframes marquee{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
#player #p-now{font-size:.75rem;color:var(--accent);white-space:nowrap}
#p-play,#p-prev,#p-next{background:none;border:none;color:var(--accent);
                        font-size:1.8rem;cursor:pointer;padding:0.25rem}
#sleepBtn{background:none;border:none;color:var(--accent);font-size:1.5rem;cursor:pointer}
audio{display:none}
#sleepModal{position:fixed;inset:0;background:rgba(0,0,0,.5);
           display:none;align-items:center;justify-content:center;z-index:999}
#sleepModal>div{background:var(--card);padding:1rem;border-radius:.5rem;
                text-align:center;color:var(--text)}
#sleepModal button{margin:.3rem;padding:.4rem .8rem;border:1px solid var(--border);
                   border-radius:.3rem;background:var(--bg);color:var(--text)}
#sleepModal button:hover{background:var(--accent);color:#fff}
</style>
</head>
<body>
<header>
  <span>TC RADIOS</span>
  <div id="langBox">
    <select id="langSelect"></select>
  </div>
  <button id="themeToggle" title="Dark / Light">üåô</button>
</header>

<div id="tabs">
  <span id="tab-all" class="active">All</span>
  <span id="tab-fav">Favorites</span>
  <span id="tab-about">About</span>
</div>

<div id="content" aria-busy="true">
  <div class="station-list"></div>
</div>

<!-- ABOUT PANEL -->
<div id="about-panel">
  <div class="about-card">
    <img src="https://raw.githubusercontent.com/simsonpeter/Tcradios/main/icons/icon-512x512.png" alt="Logo"/>
    <h2>TC RADIOS</h2>
  </div>
  <div class="about-card">
    <h2>About Us</h2>
    <p>TC RADIOS brings uplifting Christian music and messages worldwide.</p>
  </div>
  <div class="about-card">
    <h2>Contact Us</h2>
    <p><strong>JayathaSoft</strong><br>
       üìß <a href="mailto:simsonpeter@gmail.com" style="color:var(--accent)">simsonpeter@gmail.com</a><br>
       üìç Antwerp, Belgium</p>
  </div>
</div>

<!-- PLAYER -->
<div id="player">
  <img id="p-img" src="https://raw.githubusercontent.com/simsonpeter/Tcradios/main/icons/default-artwork.jpg" alt="Artwork"/>
  <div class="info">
    <div class="name"><span id="p-name"></span></div>
    <div id="p-now">Live</div>
  </div>
  <button id="p-prev" title="Previous">‚èÆ</button>
  <button id="p-play" title="Play/Pause">‚ñ∂</button>
  <button id="p-next" title="Next">‚è≠</button>
  <button id="sleepBtn" title="Sleep timer">‚è∞</button>
</div>

<div id="sleepModal">
  <div>
    <h3>Sleep Timer</h3>
    <button data-min="15">15 min</button><button data-min="30">30 min</button>
    <button data-min="45">45 min</button><button data-min="60">60 min</button><br>
    <input type="number" id="customMin" placeholder="min" style="width:70px"/>
    <button id="setCustom">Set</button><br>
    <button id="cancelSleep">Cancel</button>
  </div>
</div>

<audio id="audio"></audio>

<script>
/* ---- CONFIG ---- */
const LANG_URLS = {
  tamil:    'https://raw.githubusercontent.com/simsonpeter/Tcradios/refs/heads/main/stations.json',
  malayalam:'https://raw.githubusercontent.com/simsonpeter/Tcradios/refs/heads/main/languages/malayalam.json'
};

/* ---- STATE ---- */
let stationsPerLang = {};
let favorites       = JSON.parse(localStorage.getItem('tcr-fav') || '[]');
let currentLang     = localStorage.getItem('currentLang') || 'tamil';
let currentTab      = localStorage.getItem('currentTab') || 'all';
let currentList     = [];
let idx             = 0;
let sleepTimer      = null;

/* ---- LOAD LANGUAGES ---- */
async function loadAll() {
  const promises = Object.keys(LANG_URLS).map(async lang => {
    const res = await fetch(LANG_URLS[lang]);
    stationsPerLang[lang] = await res.json();
  });
  await Promise.allSettled(promises);
  populateLangSelect();
  switchTab(currentTab);
}
loadAll();

function populateLangSelect() {
  const sel = document.getElementById('langSelect');
  sel.innerHTML = '';
  Object.keys(LANG_URLS).forEach(lang => {
    const opt = document.createElement('option');
    opt.value = lang;
    opt.textContent = lang.charAt(0).toUpperCase() + lang.slice(1);
    if (lang === currentLang) opt.selected = true;
    sel.appendChild(opt);
  });
  sel.onchange = () => {
    currentLang = sel.value;
    localStorage.setItem('currentLang', currentLang);
    switchTab(currentTab);
  };
}

/* ---- TABS ---- */
let touchStartX = 0;
let touchEndX = 0;
document.getElementById('tab-all').onclick   = () => switchTab('all');
document.getElementById('tab-fav').onclick   = () => switchTab('fav');
document.getElementById('tab-about').onclick = () => switchTab('about');
document.getElementById('content').addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX });
document.getElementById('content').addEventListener('touchend', e => {
  touchEndX = e.changedTouches[0].screenX;
  const th = 50;
  if (touchEndX < touchStartX - th) {
    const i = ['all','fav','about'].indexOf(currentTab);
    if (i < 2) switchTab(['all','fav','about'][i+1]);
  } else if (touchStartX < touchEndX - th) {
    const i = ['all','fav','about'].indexOf(currentTab);
    if (i > 0) switchTab(['all','fav','about'][i-1]);
  }
});

function switchTab(tab) {
  currentTab = tab;
  localStorage.setItem('currentTab', tab);
  document.querySelectorAll('#tabs span').forEach(s => s.classList.remove('active'));
  document.getElementById(`tab-${tab}`).classList.add('active');
  if (tab === 'about') {
    document.getElementById('content').style.display = 'none';
    document.getElementById('about-panel').style.display = 'flex';
  } else {
    document.getElementById('content').style.display = 'flex';
    document.getElementById('about-panel').style.display = 'none';
    const list = tab === 'fav'
      ? Object.values(stationsPerLang).flat().filter(s => favorites.includes(s.name))
      : stationsPerLang[currentLang] || [];
    currentList = list;
    render(list);
  }
}

/* ---- RENDER ---- */
const content = document.getElementById('content');
const player  = document.getElementById('player');
const audio   = document.getElementById('audio');
const pImg    = document.getElementById('p-img');
const pName   = document.getElementById('p-name');

function render(list) {
  if (!list || !list.length) {
    content.innerHTML = '<div class="station-list"><div class="item">No stations.</div></div>';
    return;
  }
  const stationList = document.createElement('div');
  stationList.className = 'station-list';
  list.forEach((st, i) => {
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <img src="${st.logo}" alt="" class="station-icon">
      <div class="station-info">
        <div class="station-name">${st.name}</div>
        <div class="station-genre">${st.genre}</div>
      </div>
      <div class="favorite-button ${favorites.includes(st.name) ? 'on' : ''}" data-name="${st.name}">‚ô•</div>
    `;
    div.onclick = e => { if (!e.target.classList.contains('favorite-button')) play(st, i); };
    div.querySelector('.favorite-button').onclick = e => {
      e.stopPropagation(); toggleFav(st.name);
    };
    stationList.appendChild(div);
  });
  content.innerHTML = '';
  content.appendChild(stationList);
}

/* ---- PLAYER ---- */
function play(st, i) {
  idx = i;
  audio.src = st.url;
  pImg.src = st.logo || 'https://raw.githubusercontent.com/simsonpeter/Tcradios/main/icons/default-artwork.jpg';
  pName.innerHTML = '<span>' + st.name + '</span>';
  player.classList.add('playing');
  audio.play().catch(()=>{});
  updateMediaSession(st);
  fetchNowPlaying(st.url);
}
audio.onplay  = () => { pPlay.textContent = '‚è∏'; player.classList.add('playing'); };
audio.onpause = () => { pPlay.textContent = '‚ñ∂'; player.classList.remove('playing'); };
const pPlay = document.getElementById('p-play');
pPlay.onclick = () => audio.paused ? audio.play() : audio.pause();
function prevNext(dir) {
  if (!currentList.length) return;
  idx = (idx + dir + currentList.length) % currentList.length;
  play(currentList[idx], idx);
}
document.getElementById('p-prev').onclick = () => prevNext(-1);
document.getElementById('p-next').onclick = () => prevNext(1);

/* ---- NOW-PLAYING ---- */
function fetchNowPlaying(url) {
  const proxy = 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(url);
  const check = () => {
    fetch(proxy, {cache: 'no-store'})
      .then(r => r.text())
      .then(txt => {
        const m = txt.match(/StreamTitle='([^']+)'/);
        document.getElementById('p-now').textContent = m ? m[1] : 'Live';
      })
      .catch(() => document.getElementById('p-now').textContent = 'Live');
  };
  check();
  const t = setInterval(check, 15000);
  audio.addEventListener('pause', () => clearInterval(t), { once: true });
}

/* ---- FAVORITES ---- */
function toggleFav(name) {
  favorites = favorites.includes(name)
    ? favorites.filter(f => f !== name)
    : [...favorites, name];
  localStorage.setItem('tcr-fav', JSON.stringify(favorites));
  switchTab(currentTab);
}

/* ---- THEME ---- */
const themeToggle = document.getElementById('themeToggle');
function applyTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  localStorage.theme = t;
  themeToggle.textContent = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}
applyTheme(localStorage.theme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
themeToggle.onclick = () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');

/* ---- SLEEP TIMER ---- */
const sleepModal = document.getElementById('sleepModal');
const sleepBtn   = document.getElementById('sleepBtn');
sleepBtn.onclick = () => sleepModal.style.display = 'flex';
document.getElementById('cancelSleep').onclick = () => {
  clearTimeout(sleepTimer);
  sleepModal.style.display = 'none';
};
document.querySelectorAll('#sleepModal button[data-min]').forEach(btn => {
  btn.onclick = () => setSleep(parseInt(btn.dataset.min));
});
document.getElementById('setCustom').onclick = () => {
  const m = parseInt(document.getElementById('customMin').value);
  if (m > 0) setSleep(m);
};
function setSleep(min) {
  clearTimeout(sleepTimer);
  sleepTimer = setTimeout(() => {
    audio.pause();
    document.getElementById('p-now').textContent = 'Live';
    sleepModal.style.display = 'none';
  }, min * 60000);
  sleepModal.style.display = 'none';
}

/* ---- MEDIA SESSION ---- */
function updateMediaSession(st) {
  if ('mediaSession' in navigator) {
    navigator.mediaSession.metadata = new MediaMetadata({
      title: st.name,
      artist: 'TC RADIOS',
      album: st.genre,
      artwork: [{
        src: st.logo || 'https://raw.githubusercontent.com/simsonpeter/Tcradios/main/icons/icon-512x512.png',
        sizes: '512x512', type: 'image/png'
      }]
    });
    navigator.mediaSession.setActionHandler('play', () => audio.play());
    navigator.mediaSession.setActionHandler('pause', () => audio.pause());
    navigator.mediaSession.setActionHandler('previoustrack', () => prevNext(-1));
    navigator.mediaSession.setActionHandler('nexttrack', () => prevNext(1));
  }
}
</script>
</body>
</html>
