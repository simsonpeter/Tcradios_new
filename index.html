<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>TC RADIOS</title>

<!-- PWA essentials -->
<link rel="manifest" href="/manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TC RADIOS">
<link rel="apple-touch-icon" href="/icons/icon-192x192.png">
<link rel="icon" href="/icons/favicon.ico">

<!-- TWA/Android specific meta tags -->
<meta name="theme-color" content="#f97316">
<meta name="msapplication-navbutton-color" content="#f97316">
<meta name="msapplication-TileColor" content="#111827">
<meta name="application-name" content="TC RADIOS">

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --accent:#f97316;--bg:#111827;--card:#1f2937;--text:#f3f4f6;
  --border:#374151;--header:#000000;--heart:#f3f4f6;
  --header-btn:#f3f4f6;--player-height:80px;
}
[data-theme="light"]{
  --bg:#f5f7fa;--card:#ffffff;--text:#1e293b;
  --border:#d1d5db;--header:#ffffff;--heart:#1e293b;
  --header-btn:#1e293b;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;height:100vh;height:100dvh;width:100%;overflow:hidden}
body{display:flex;flex-direction:column;font-family:system-ui;
     background:var(--bg);color:var(--text);overflow:hidden;
     /* Ensure fullscreen on mobile */
     position:fixed;top:0;left:0;right:0;bottom:0;
     /* Handle safe areas for notched devices */
     padding-top:env(safe-area-inset-top);
     padding-bottom:env(safe-area-inset-bottom);
     padding-left:env(safe-area-inset-left);
     padding-right:env(safe-area-inset-right)}
header{background:var(--header);border-bottom:1px solid var(--border);
       display:flex;justify-content:space-between;align-items:center;
       padding:1rem 1.2rem;font-size:1.25rem;font-weight:700;min-height:70px}
header button{background:none;border:none;font-size:1.4rem;cursor:pointer;padding:0.5rem;border-radius:50%;transition:all 0.2s ease;color:var(--header-btn)}
header button:hover{background:rgba(249,115,22,0.1);transform:scale(1.05)}
header button:active{transform:scale(0.95)}
header button i{font-size:1.2rem;color:var(--header-btn)}
#headerControls{display:flex;align-items:center;gap:0.8rem}
#langBox{position:relative}
#langSelect{appearance:none;background:var(--card);color:var(--text);
            border:1px solid var(--border);border-radius:.4rem;
            padding:.35rem .6rem;font-size:1rem;cursor:pointer}
#tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;
      background:var(--header)}
#tabs span{flex:1;text-align:center;padding:.55rem 0;cursor:pointer;
           font-weight:600;color:var(--text)}
#tabs span.active{background:var(--accent);color:#fff;border-radius:.4rem}
#content,#about-panel{flex:1;overflow-y:auto;padding:.75rem 1rem var(--player-height);
                      display:flex;flex-direction:column}
#about-panel{display:none;align-items:center;justify-content:center}
.about-card{background:var(--card);border-radius:.5rem;padding:1rem;
            text-align:center;box-shadow:0 1px 3px rgba(0,0,0,.08);
            width:90%;max-width:400px;margin-bottom:1rem}
.about-card img{width:90px;height:90px;border-radius:50%;object-fit:cover;margin-bottom:.5rem}
.about-card h2{margin:.3rem 0;font-size:1.2rem;color:var(--accent)}
.about-card p{font-size:.9rem;line-height:1.4}
.about-card i{margin-right:.5rem;color:var(--accent)}
#searchBar{width:100%;margin-bottom:.75rem;padding:.55rem .7rem;border-radius:.4rem;
           border:1px solid var(--border);background:var(--card);color:var(--text);
           font-size:1rem}
#searchBar::placeholder{color:var(--border)}
.station-list{width:100%;display:flex;flex-direction:column;gap:.4rem}
.item{display:flex;align-items:center;gap:12px;padding:.5rem;border-radius:.5rem;
      background:var(--card);box-shadow:0 1px 3px rgba(0,0,0,.08)}
.station-icon{width:48px;height:48px;border-radius:50%;object-fit:cover}
.station-info{flex:1;display:flex;flex-direction:column;text-align:left}
.station-name{font-weight:600}
.station-genre{font-size:.8rem;color:var(--accent)}
.favorite-button{font-size:1.3rem;color:var(--heart);cursor:pointer}
.favorite-button i{font-size:1.1rem}
.favorite-button.on{color:var(--accent)}
#player{background:var(--header);border-top:1px solid var(--border);
        display:flex;align-items:center;gap:1rem;padding:1rem 1.2rem;
        position:fixed;bottom:0;width:100%;flex-shrink:0;z-index:100;
        box-shadow:0 -2px 10px rgba(0,0,0,0.1);backdrop-filter:blur(10px)}
#player img{width:56px;height:56px;border-radius:50%;
           animation:spin 3s linear infinite paused;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
#player.playing img{animation-play-state:running}
@keyframes spin{to{transform:rotate(360deg)}}
#player .info{flex:1;display:flex;flex-direction:column;justify-content:center;min-width:0;margin:0 1rem}
#player .name{white-space:nowrap;overflow:hidden;font-weight:700;font-size:1rem;margin-bottom:0.2rem}
#player .name span{display:inline-block;padding-right:1rem;
                   animation:marquee 8s linear infinite}
@keyframes marquee{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
#player #p-now{font-size:.8rem;color:var(--accent);white-space:nowrap;font-weight:500}
#p-play,#p-prev,#p-next{background:rgba(249,115,22,0.1);border:none;color:var(--accent);
                        font-size:1.8rem;cursor:pointer;padding:0.8rem;border-radius:50%;
                        transition:all 0.2s ease;min-width:48px;min-height:48px;
                        display:flex;align-items:center;justify-content:center;
                        box-shadow:0 2px 4px rgba(0,0,0,0.1)}
#p-play:hover,#p-prev:hover,#p-next:hover{background:rgba(249,115,22,0.2);transform:scale(1.05)}
#p-play:active,#p-prev:active,#p-next:active{transform:scale(0.95)}
#p-play i,#p-prev i,#p-next i{font-size:1.3rem}

/* Mobile responsive adjustments */
@media (max-width: 480px) {
  #player{gap:0.8rem;padding:0.8rem 1rem}
  #player img{width:48px;height:48px}
  #player .info{margin:0 0.8rem}
  #player .name{font-size:0.9rem}
  #player #p-now{font-size:0.75rem}
  #p-play,#p-prev,#p-next{padding:0.6rem;min-width:44px;min-height:44px}
  #p-play i,#p-prev i,#p-next i{font-size:1.2rem}
  header{padding:0.8rem 1rem;min-height:60px}
  #headerControls{gap:0.6rem}
}

audio{display:none}
#sleepModal{position:fixed;inset:0;background:rgba(0,0,0,.5);
           display:none;align-items:center;justify-content:center;z-index:999}
#sleepModal>div{background:var(--card);padding:1rem;border-radius:.5rem;
                text-align:center;color:var(--text)}
#sleepModal button{margin:.3rem;padding:.4rem .8rem;border:1px solid var(--border);
                   border-radius:.3rem;background:var(--bg);color:var(--text)}
#sleepModal button:hover{background:var(--accent);color:#fff}
</style>
</head>
<body>
<header>
  <span>TC RADIOS</span>
  <div id="headerControls">
    <div id="langBox">
      <select id="langSelect"></select>
    </div>
    <button id="sleepBtn" title="Sleep timer"><i class="fas fa-clock"></i></button>
    <button id="themeToggle" title="Dark / Light"><i class="fas fa-moon"></i></button>
  </div>
</header>

<div id="tabs">
  <span id="tab-all" class="active">All</span>
  <span id="tab-fav">Favorites</span>
  <span id="tab-about">About</span>
</div>

<div id="content" aria-busy="true">
  <input id="searchBar" type="search" placeholder="Search stationsâ€¦" autocomplete="off"/>
  <div class="station-list"></div>
</div>

<div id="about-panel">
  <div class="about-card">
    <img src="/icons/icon-512x512.png" alt="Logo"/>
    <h2>TC RADIOS</h2>
  </div>
  <div class="about-card">
    <h2>About Us</h2>
    <p>TC RADIOS brings uplifting Christian music and messages worldwide.</p>
  </div>
  <div class="about-card">
    <h2>Contact Us</h2>
    <p><strong>JayathaSoft</strong><br>
       <i class="fas fa-envelope"></i> <a href="mailto:simsonpeter@gmail.com">simsonpeter@gmail.com</a><br>
       <i class="fas fa-map-marker-alt"></i> Antwerp, Belgium</p>
  </div>
</div>

<div id="player">
  <img id="p-img" src="/icons/default-artwork.jpg" alt="Artwork"/>
  <div class="info">
    <div class="name"><span id="p-name"></span></div>
    <div id="p-now">Live</div>
  </div>
  <button id="p-prev" title="Previous"><i class="fas fa-step-backward"></i></button>
  <button id="p-play" title="Play/Pause"><i class="fas fa-play"></i></button>
  <button id="p-next" title="Next"><i class="fas fa-step-forward"></i></button>
</div>

<div id="sleepModal">
  <div>
    <h3>Sleep Timer</h3>
    <button data-min="15">15 min</button><button data-min="30">30 min</button>
    <button data-min="45">45 min</button><button data-min="60">60 min</button><br>
    <input type="number" id="customMin" placeholder="min" style="width:70px"/>
    <button id="setCustom">Set</button><br>
    <button id="cancelSleep">Cancel</button>
  </div>
</div>

<audio id="audio"></audio>

<script>
/* ---- CONFIG ---- */
const LANG_URLS = {
  tamil:    'https://raw.githubusercontent.com/simsonpeter/Tcradios/refs/heads/main/stations.json',
  malayalam:'https://raw.githubusercontent.com/simsonpeter/Tcradios/refs/heads/main/languages/malayalam.json'
};

/* ---- STATE ---- */
let stationsPerLang = {};
let favorites       = JSON.parse(localStorage.getItem('tcr-fav') || '[]');
let currentLang     = localStorage.getItem('currentLang') || 'tamil';
let currentTab      = localStorage.getItem('currentTab') || 'all';
let currentList     = [];
let idx             = 0;
let searchTerm      = '';
let sleepTimer;
let lastPlayedStation = JSON.parse(localStorage.getItem('tcr-last-played') || 'null');

/* ---- ELEMENTS ---- */
const searchBar   = document.getElementById('searchBar');
const stationList = document.querySelector('.station-list');
const audio       = document.getElementById('audio');
const pImg        = document.getElementById('p-img');
const pName       = document.getElementById('p-name');
const pPlay       = document.getElementById('p-play');
const player      = document.getElementById('player');

/* ---- LOAD + INIT ---- */
async function loadAll() {
  const promises = Object.keys(LANG_URLS).map(async lang => {
    const res = await fetch(LANG_URLS[lang]);
    stationsPerLang[lang] = await res.json();
  });
  await Promise.allSettled(promises);
  populateLangSelect();
  switchTab(currentTab);
  
  // Auto-play last played station or first station
  setTimeout(() => {
    autoPlayLastOrFirst();
  }, 500); // Small delay to ensure UI is ready
}
loadAll();

function autoPlayLastOrFirst() {
  // Check if there's a last played station
  if (lastPlayedStation && lastPlayedStation.lang === currentLang) {
    const stations = stationsPerLang[currentLang] || [];
    const lastStation = stations.find(st => st.name === lastPlayedStation.station.name);
    
    if (lastStation) {
      const index = stations.indexOf(lastStation);
      play(lastStation, index);
      return;
    }
  }
  
  // If no last played station or it's not found, play first station
  const stations = stationsPerLang[currentLang] || [];
  if (stations.length > 0) {
    play(stations[0], 0);
  }
}

function populateLangSelect() {
  const sel = document.getElementById('langSelect');
  sel.innerHTML = '';
  Object.keys(LANG_URLS).forEach(lang => {
    const opt = document.createElement('option');
    opt.value = lang;
    opt.textContent = lang.charAt(0).toUpperCase() + lang.slice(1);
    if (lang === currentLang) opt.selected = true;
    sel.appendChild(opt);
  });
  sel.onchange = () => {
    currentLang = sel.value;
    localStorage.setItem('currentLang', currentLang);
    switchTab(currentTab);
    
    // Auto-play last played station or first station when language changes
    setTimeout(() => {
      autoPlayLastOrFirst();
    }, 100);
  };
}

/* ---- TABS + SEARCH ---- */
document.getElementById('tab-all').onclick   = () => switchTab('all');
document.getElementById('tab-fav').onclick   = () => switchTab('fav');
document.getElementById('tab-about').onclick = () => switchTab('about');
document.getElementById('content').addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
document.getElementById('content').addEventListener('touchend', e => {
  const th = 50;
  if (e.changedTouches[0].screenX < touchStartX - th) {
    const i = ['all','fav','about'].indexOf(currentTab);
    if (i < 2) switchTab(['all','fav','about'][i+1]);
  } else if (touchStartX < e.changedTouches[0].screenX - th) {
    const i = ['all','fav','about'].indexOf(currentTab);
    if (i > 0) switchTab(['all','fav','about'][i-1]);
  }
});
searchBar.addEventListener('input', e => {
  searchTerm = e.target.value.trim().toLowerCase();
  switchTab(currentTab);
});

function switchTab(tab) {
  currentTab = tab;
  localStorage.setItem('currentTab', tab);
  document.querySelectorAll('#tabs span').forEach(s => s.classList.remove('active'));
  document.getElementById(`tab-${tab}`).classList.add('active');
  if (tab === 'about') {
    document.getElementById('content').style.display = 'none';
    document.getElementById('about-panel').style.display = 'flex';
    searchBar.style.display = 'none';
  } else {
    document.getElementById('content').style.display = 'flex';
    document.getElementById('about-panel').style.display = 'none';
    searchBar.style.display = '';
    let base = tab === 'fav'
      ? Object.values(stationsPerLang).flat().filter(s => favorites.includes(s.name))
      : stationsPerLang[currentLang] || [];
    currentList = base.filter(s => !searchTerm || s.name.toLowerCase().includes(searchTerm));
    render(currentList);
  }
}

/* ---- RENDER ---- */
function render(list) {
  stationList.innerHTML = '';
  if (!list || !list.length) {
    stationList.innerHTML = '<div class="item">No stations found.</div>';
    return;
  }
  list.forEach((st, i) => {
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <img src="${st.logo}" alt="" class="station-icon">
      <div class="station-info">
        <div class="station-name">${st.name}</div>
        <div class="station-genre">${st.genre}</div>
      </div>
      <div class="favorite-button ${favorites.includes(st.name) ? 'on' : ''}" data-name="${st.name}"><i class="fas fa-heart"></i></div>
    `;
    div.onclick = e => { if (!e.target.classList.contains('favorite-button')) play(st, i); };
    div.querySelector('.favorite-button').onclick = e => {
      e.stopPropagation(); toggleFav(st.name);
    };
    stationList.appendChild(div);
  });
}

/* ---- PLAYER ---- */
function play(st, i) {
  idx = i;
  audio.src = st.url;
  pImg.src = st.logo || '/icons/default-artwork.jpg';
  pName.innerHTML = '<span>' + st.name + '</span>';
  player.classList.add('playing');
  audio.play().catch(()=>{});
  updateMediaSession(st);
  
  // Save last played station
  lastPlayedStation = { station: st, index: i, lang: currentLang };
  localStorage.setItem('tcr-last-played', JSON.stringify(lastPlayedStation));
}
audio.onplay  = () => { pPlay.innerHTML = '<i class="fas fa-pause"></i>'; player.classList.add('playing'); };
audio.onpause = () => { pPlay.innerHTML = '<i class="fas fa-play"></i>'; player.classList.remove('playing'); };
pPlay.onclick = () => audio.paused ? audio.play() : audio.pause();
function prevNext(dir) {
  if (!currentList.length) return;
  idx = (idx + dir + currentList.length) % currentList.length;
  play(currentList[idx], idx);
}
document.getElementById('p-prev').onclick = () => prevNext(-1);
document.getElementById('p-next').onclick = () => prevNext(1);

/* ---- FAVORITES ---- */
function toggleFav(name) {
  favorites = favorites.includes(name)
    ? favorites.filter(f => f !== name)
    : [...favorites, name];
  localStorage.setItem('tcr-fav', JSON.stringify(favorites));
  switchTab(currentTab);
}

/* ---- THEME ---- */
const themeToggle = document.getElementById('themeToggle');
function applyTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  localStorage.theme = t;
  themeToggle.innerHTML = t === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
}
applyTheme(localStorage.theme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
themeToggle.onclick = () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');

/* ---- SLEEP TIMER ---- */
const sleepModal = document.getElementById('sleepModal');
const sleepBtn   = document.getElementById('sleepBtn');
sleepBtn.onclick = () => sleepModal.style.display = 'flex';
document.getElementById('cancelSleep').onclick = () => {
  clearTimeout(sleepTimer);
  sleepModal.style.display = 'none';
};
document.querySelectorAll('#sleepModal button[data-min]').forEach(btn => {
  btn.onclick = () => setSleep(parseInt(btn.dataset.min));
});
document.getElementById('setCustom').onclick = () => {
  const m = parseInt(document.getElementById('customMin').value);
  if (m > 0) setSleep(m);
};
function setSleep(min) {
  clearTimeout(sleepTimer);
  sleepTimer = setTimeout(() => {
    audio.pause();
    document.getElementById('p-now').textContent = 'Live';
    sleepModal.style.display = 'none';
  }, min * 60000);
  sleepModal.style.display = 'none';
}

/* ---- MEDIA SESSION ---- */
function updateMediaSession(st) {
  if ('mediaSession' in navigator) {
    navigator.mediaSession.metadata = new MediaMetadata({
      title: st.name,
      artist: 'TC RADIOS',
      album: st.genre,
      artwork: [{
        src: st.logo || '/icons/icon-512x512.png',
        sizes: '512x512', type: 'image/png'
      }]
    });
    navigator.mediaSession.setActionHandler('play', () => audio.play());
    navigator.mediaSession.setActionHandler('pause', () => audio.pause());
    navigator.mediaSession.setActionHandler('previoustrack', () => prevNext(-1));
    navigator.mediaSession.setActionHandler('nexttrack', () => prevNext(1));
  }
}

/* ---- SERVICE WORKER (PWA) ---- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js');
  });
}

/* ---- DYNAMIC PLAYER HEIGHT ---- */
document.documentElement.style.setProperty('--player-height', document.getElementById('player').offsetHeight + 'px');
</script>
</body>
</html>
